// Backbone.Declarative.Views, v4.0.0
// Copyright (c) 2014-2016 Michael Heim, Zeilenwechsel.de
// Distributed under MIT license
// http://github.com/hashchange/backbone.declarative.views


!function(a,b){"use strict";var c="object"==typeof exports&&exports&&!exports.nodeType&&"object"==typeof module&&module&&!module.nodeType;"function"==typeof define&&"object"==typeof define.amd&&define.amd?define(["exports","underscore","backbone"],b):c?b(exports,require("underscore"),require("backbone")):b({},_,Backbone)}(this,function(a,_,Backbone){"use strict";function b(a,b,c){var d;return a&&_.isString(a)&&(d=B[a],d||(d=k(a,b,c)),d.invalid&&(d=void 0),d&&(d=j(d))),d}function c(a,c){var d,e=a.declarativeViews.meta;return e.processed?d=e.inGlobalCache?b(e.originalTemplateProp,a,c):void 0:a.template&&_.isString(a.template)?(e.originalTemplateProp=a.template,d=b(a.template,a,c),e.processed=!0,e.inGlobalCache=!0,d&&M.trigger("cacheEntry:view:process",j(d),e.originalTemplateProp,a,c)):(d=void 0,e.processed=!0,e.inGlobalCache=!1),d&&M.trigger("cacheEntry:view:fetch",d,e.originalTemplateProp,a,c),d}function d(a){B={},!a&&Backbone.Marionette&&Backbone.Marionette.TemplateCache&&Backbone.Marionette.TemplateCache.clear()}function e(a){var b=!1,c=_.toArray(arguments),d=_.last(c);if(c.length&&_.isBoolean(d)&&(b=c.pop()),c.length>1)_.each(c,function(a){e(a,b)});else if(_.isArray(a)||_.isArguments(a))_.each(a,function(a){e(a,b)});else{if(!a)throw new H("Missing argument: string identifying the template. The string should be a template selector or the raw HTML of a template, as provided to the template property of a view when the cache entry was created");if(_.isString(a)&&(m(a),!b&&Backbone.Marionette&&Backbone.Marionette.TemplateCache))try{Backbone.Marionette.TemplateCache.clear(a)}catch(a){}}}function f(a){var b=a.declarativeViews.meta;b.processed?b.inGlobalCache&&m(b.originalTemplateProp):a.template&&_.isString(a.template)&&m(a.template)}function g(a){var b;try{if(b=N(a),!N.contains(document.documentElement,b[0]))throw new Error}catch(c){if(b=h(a),b.html()!==a)throw new Error("Failed to wrap template string in script tag without altering it")}return b}function h(a){var b=N("<script />").attr("type","text/x-template").text(a),c=i(a);return c&&b.attr(c),b}function i(a){var b={},c=z.exec(a),d=c&&c[0];return d&&_.each(G,function(a,c){var e=a.exec(d),f=e&&e[2];f&&(b[c]=f)}),_.size(b)?b:void 0}function j(a){var b=_.clone(a);return _.isObject(b.attributes)&&(b.attributes=_.clone(b.attributes)),b}function k(a,b,c){var d,e,f,h=Backbone.DeclarativeViews.custom.loadTemplate,i=Backbone.DeclarativeViews.defaults.loadTemplate,j=i!==g,k=a;try{d=h?h(a,b,c):i(a,b,c)}catch(a){if(u(a))throw a;d=""}if((h||j)&&""!==d&&!(d instanceof Backbone.$))throw new K("Invalid return value. The "+(h?"custom":"default")+" loadTemplate function must return a jQuery instance, but it hasn't");return d.length?(e=q(d),f=d.html(),B[k]={html:f,compiled:l(f,d),tagName:e.tagName,className:e.className,id:e.id,attributes:e.attributes,_pluginData:{}}):B[k]={invalid:!0},B[k]}function l(a,b){var c,d=Backbone.DeclarativeViews.custom.compiler;if(d){if(d&&!_.isFunction(d))throw new K("Invalid custom template compiler set in Backbone.DeclarativeViews.custom.compiler: compiler is not a function");try{c=d(a,b)}catch(b){throw new J('An error occurred while compiling the template. The compiler had been passed the HTML string "'+a+'" as the first argument, and the corresponding template node, wrapped in a jQuery object, as the second argument')}}return c}function m(a){B[a]&&delete B[a]}function n(a,b){var c=o(),d="data-"+a,e=b&&b.isJSON?"json":"primitives",f=F[e];if(0===a.indexOf("data-"))throw new K('registerDataAttribute(): Illegal attribute name "'+a+'", must be registered without "data-" prefix');if("html"===a||"compiled"===a)throw new K('registerDataAttribute(): Cannot register attribute name "'+a+'" because it is reserved');if(_.contains(c,a))throw new K('registerDataAttribute(): Cannot register attribute name "'+a+'" because it has already been registered');f.push(a),F[e]=_.uniq(f),G[d]=new RegExp(d+"\\s*=\\s*(['\"])([\\s\\S]+?)\\1"),z=p()}function o(){return F.primitives.concat(F.json)}function p(){return new RegExp("<!--(?:(?!-->)[\\s\\S])*?data-(?:"+o().join("|")+")\\s*=\\s*(['\"])[\\s\\S]+?\\1[\\s\\S]*?-->")}function q(a){return r(a),a.data()}function r(a){var b={},c=[];N.hasData(a[0])&&(_.each(F.primitives,function(d){var e=a.attr("data-"+d);void 0===e?c.push(d):b[w(d)]=e}),_.each(F.json,function(d){var e=a.attr("data-"+d);if(void 0===e)c.push(d);else try{b[w(d)]=N.parseJSON(e)}catch(a){c.push(d)}}),c.length&&a.removeData(c),_.size(b)&&a.data(b))}function s(a,b){a.getCachedTemplate=Backbone.DeclarativeViews.getCachedTemplate,a.clearCachedTemplate=Backbone.DeclarativeViews.clearCachedTemplate,a.clearCache=Backbone.DeclarativeViews.clearCache,a.custom=Backbone.DeclarativeViews.custom,b&&(C.push(b),C=_.unique(C))}function t(){D=!0}function u(a){return a instanceof H||a instanceof I||a instanceof J||a instanceof K||a instanceof L}function v(){Backbone.Marionette&&Backbone.Marionette.TemplateCache&&!E&&(y=Backbone.Marionette.TemplateCache.clear,Backbone.Marionette.TemplateCache.clear=function(){arguments.length?Backbone.DeclarativeViews.clearCachedTemplate(arguments,!0):Backbone.DeclarativeViews.clearCache(!0),y.apply(this,arguments)},E=!0)}function w(a){return a.replace(/([^-])-([a-z])/g,function(a,b,c){return b+c.toUpperCase()})}function x(a){function b(a){this.message=a,Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack}return b.prototype=new Error,b.prototype.name=a,b.prototype.constructor=b,b}var y,z,A=Backbone.View,B={},C=[],D=!1,E=!1,F={primitives:[],json:[]},G={},H=x("Backbone.DeclarativeViews.Error"),I=x("Backbone.DeclarativeViews.TemplateError"),J=x("Backbone.DeclarativeViews.CompilerError"),K=x("Backbone.DeclarativeViews.CustomizationError"),L=x("Backbone.DeclarativeViews.ConfigurationError"),M=_.clone(Backbone.Events),N=Backbone.$;_.extend(Backbone.View.prototype,{tagName:function(){var a=c(this)||{};return a.tagName||"div"},className:function(){var a=c(this)||{};return a.className||void 0},id:function(){var a=c(this)||{};return a.id||void 0},attributes:function(){var a=c(this)||{};return a.attributes||void 0}}),Backbone.View=Backbone.View.extend({constructor:function(a){a&&void 0!==a.template&&(this.template=a.template),this.declarativeViews={meta:{viewId:_.uniqueId("view-")},getCachedTemplate:_.partial(c,this),clearCachedTemplate:_.partial(f,this)},_.each(C,function(a){this[a]=this.declarativeViews},this),D&&c(this,a),A.apply(this,arguments)}}),Backbone.DeclarativeViews={getCachedTemplate:b,clearCachedTemplate:e,clearCache:d,joinMarionette:v,Error:H,TemplateError:I,CompilerError:J,CustomizationError:K,ConfigurationError:L,plugins:{registerDataAttribute:n,getDataAttributes:q,updateJqueryDataCache:r,registerCacheAlias:s,enforceTemplateLoading:t,events:M},defaults:{loadTemplate:g},custom:{loadTemplate:void 0,compiler:void 0},version:"4.0.0"},n("tag-name"),n("class-name"),n("id"),n("attributes",{isJSON:!0}),a.info="Backbone.Declarative.Views has loaded. Don't use the exported value of the module. Its functionality is available inside the Backbone namespace."});
//# sourceMappingURL=backbone.declarative.views.min.js.map